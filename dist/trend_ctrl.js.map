{"version":3,"sources":["../src/trend_ctrl.js"],"names":["MetricsPanelCtrl","_","kbn","TimeSeries","TrendCtrl","$scope","$injector","$rootScope","panelDefaults","isValueColored","colors","colorInBackground","thresholds","prefix","postfix","valueName","format","prefixFontSize","valueFontSize","postfixFontSize","trend","show","signFontSize","unitFontSize","showDiff","sign","defaultsDeep","panel","events","on","onDataReceived","bind","onDataError","onInitEditMode","onPanelTeardown","render","data","percent","valueNameOptions","value","text","err","console","log","dataList","series","map","seriesHandler","setValues","fontSizes","unitFormats","getUnitFormats","addEditorTab","$timeout","cancel","nextTickPromise","panelColorIndex","color","seriesData","datapoints","alias","target","flotpairs","getFlotPairs","nullPointMode","length","lastPoint","last","lastValue","isArray","valueRounded","valueFormatted","isString","escape","formatFunc","valueFormats","stats","decimalInfo","getDecimalsForValue","decimals","scaledDecimals","roundValue","scopedVars","extend","label","NaN","targets","getTrendValue","undefined","original","current","increase","numDecimals","Math","abs","parseFloat","round","toFixed","percentFull","percentDecimals","pow","increaseFormatted","increaseRounded","subItem","refresh","isNumber","delta","dec","floor","LN10","magn","norm","size","result","max","tmp","isFinite","split","Number","strVale","trim","i","first","scope","elem","$panelContainer","find","$valueContainer","$prefixContainer","$postfixContainer","$trendContainer","$signContainer","$unitContainer","$diffContainer","$trendValueContainer","$trendDigitContainer","html","css","hasOwnProperty","backgroundColor","getColorForTrendValue","foregroundColor","removeAttr","getColorForValue","templateUrl"],"mappings":"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","file":"trend_ctrl.js","sourcesContent":["import {MetricsPanelCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport TimeSeries from 'app/core/time_series';\r\n// import rendering from './rendering';\r\nimport './css/trend-panel.css!';\r\n\r\nexport class TrendCtrl extends MetricsPanelCtrl {\r\n\r\n  constructor($scope, $injector, $rootScope) {\r\n    super($scope, $injector);\r\n    this.$rootScope = $rootScope;\r\n\r\n    const panelDefaults = {\r\n      isValueColored : false,\r\n      colors: ['#d44a3a', '#e5ac0e', '#299c46'],\r\n      colorInBackground : false,\r\n      thresholds : \"\",\r\n      prefix: '',\r\n      postfix: '',\r\n      valueName: 'avg',\r\n      format: 'none',\r\n      prefixFontSize: '50%',\r\n      valueFontSize: '80%',\r\n      postfixFontSize: '50%',\r\n      trend: {\r\n        show: true,\r\n        valueFontSize: '80%',\r\n        signFontSize: '70%',\r\n        unitFontSize: '50%',\r\n        showDiff: false,\r\n        colors: ['#d44a3a', '#e5ac0e', '#299c46'],\r\n        sign: ['▼', '▶', '▲'],\r\n        colorInBackground: false,\r\n        thresholds : \"0,0\"\r\n      },\r\n    };\r\n\r\n    _.defaultsDeep(this.panel, panelDefaults);\r\n\r\n    this.events.on('data-received', this.onDataReceived.bind(this));\r\n    this.events.on('data-error', this.onDataError.bind(this));\r\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n    this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n    this.events.on('panel-initialized', this.render.bind(this));\r\n\r\n    this.data = {trend: {percent: 0, sign: 0}};\r\n\r\n    this.valueNameOptions = [\r\n      { value: 'min', text: 'Min' },\r\n      { value: 'max', text: 'Max' },\r\n      { value: 'avg', text: 'Average' },\r\n      { value: 'current', text: 'Current' },\r\n      { value: 'total', text: 'Total' },\r\n      { value: 'name', text: 'Name' },\r\n      { value: 'first', text: 'First' },\r\n      { value: 'delta', text: 'Delta' },\r\n      { value: 'diff', text: 'Difference' },\r\n      { value: 'range', text: 'Range' },\r\n      { value: 'last_time', text: 'Time of last point' },\r\n    ];\r\n  }\r\n\r\n  //\r\n  // Event Handling\r\n  //\r\n  onDataError(err) {\r\n    console.log(err);\r\n    this.onDataReceived([]);\r\n  }\r\n\r\n  onDataReceived(dataList) {\r\n    const data = {};\r\nconsole.log('onDataReceived()', dataList)\r\n    this.series = dataList.map(this.seriesHandler.bind(this));\r\n    this.setValues(data);\r\n\r\n    this.data = data;\r\n    this.render();\r\n  }\r\n\r\n  onInitEditMode() {\r\n    this.fontSizes = ['20%', '30%', '50%', '70%', '80%', '100%', '110%', '120%', '150%', '170%', '200%'];\r\n    this.unitFormats = kbn.getUnitFormats();\r\n    this.addEditorTab('Options', 'public/plugins/trend-panel/editor.html', 2);\r\n  }\r\n\r\n  onPanelTeardown() {\r\n    this.$timeout.cancel(this.nextTickPromise);\r\n  }\r\n\r\n  onColorChange(colors, panelColorIndex) {\r\n    return color => {\r\n      colors[panelColorIndex] = color;\r\n      this.render();\r\n    };\r\n  }\r\n\r\n  //\r\n  // Data Handling\r\n  //\r\n  seriesHandler(seriesData) {\r\n    const series = new TimeSeries({\r\n      datapoints: seriesData.datapoints || [],\r\n      alias: seriesData.target,\r\n    });\r\n\r\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\r\n    return series;\r\n  }\r\n\r\n  setValues(data) {\r\n    data.flotpairs = [];\r\n\r\n    // console.log(`${this.panel.prefix} > setValues()`)\r\n    // console.log(this.series)\r\n\r\n    if (this.series && this.series.length > 0) {\r\n      const lastPoint = _.last(this.series[0].datapoints);\r\n      const lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\r\n\r\n      if (this.panel.valueName === 'name') {\r\n        data.value = 0;\r\n        data.valueRounded = 0;\r\n        data.valueFormatted = this.series[0].alias;\r\n      } else if (_.isString(lastValue)) {\r\n        data.value = 0;\r\n        data.valueFormatted = _.escape(lastValue);\r\n        data.valueRounded = 0;\r\n      } else if (this.panel.valueName === 'last_time') {\r\n        const formatFunc = kbn.valueFormats[this.panel.format];\r\n        data.value = lastPoint[1];\r\n        data.valueRounded = data.value;\r\n        data.valueFormatted = formatFunc(data.value, 0, 0);\r\n      } else {\r\n        data.value = this.series[0].stats[this.panel.valueName];\r\n        data.flotpairs = this.series[0].flotpairs;\r\n\r\n        const decimalInfo = this.getDecimalsForValue(data.value);\r\n        const formatFunc = kbn.valueFormats[this.panel.format];\r\n        data.valueFormatted = formatFunc(data.value, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n        data.valueRounded = kbn.roundValue(data.value, decimalInfo.decimals);\r\n      }\r\n\r\n      // Add $__name variable for using in prefix or postfix\r\n      data.scopedVars = _.extend({}, this.panel.scopedVars);\r\n      data.scopedVars['__name'] = { value: this.series[0].label }; // eslint-disable-line\r\n    }\r\n    else {\r\n      data.value = NaN;\r\n      data.valueRounded = NaN;\r\n      data.valueFormatted = null;\r\n    }\r\n\r\n    if (this.series && this.series.length >= 1 && data.value != null && this.panel.targets.length > 1) {\r\n      this.getTrendValue(data, this.series[1] === undefined ? 0 : this.series[1].stats[this.panel.valueName], data.value);\r\n    } else {\r\n      data.trend = {}\r\n    }\r\n\r\n    console.log(`${this.panel.prefix} > trend`)\r\n    console.log(data.trend)\r\n  }\r\n\r\n  getTrendValue(data, original, current) {\r\n\r\n    data.trend = {};\r\n    // const original = 130.2456;\r\n    const increase = current - original;\r\n\r\n    // console.log(current, original, increase)\r\n\r\n    let percent = 0;\r\n    if (original !== 0) {\r\n      percent = (increase / original) * 100;\r\n      if (percent > 0) {\r\n        data.trend.sign = 1;\r\n      } else if (percent < 0) {\r\n        data.trend.sign = -1;\r\n      } else {\r\n        data.trend.sign = 0;\r\n      }\r\n      const numDecimals = 2;\r\n      data.trend.percent = Math.abs(parseFloat(Math.round(percent * 100) / 100).toFixed(numDecimals));\r\n      data.trend.percentFull = data.trend.percent | 0;\r\n      data.trend.percentDecimals = Math.round((data.trend.percent % 1).toFixed(numDecimals) * Math.pow(10, numDecimals))\r\n    } else {\r\n      if (current > 0) {\r\n        data.trend.sign = 1;\r\n      } else if (current < 0) {\r\n        data.trend.sign = -1;\r\n      } else {\r\n        data.trend.sign = 0;\r\n      }     \r\n\r\n      // Cannot divide by zero, percent change must be represented as NaN\r\n      data.trend.percent = NaN;\r\n    }\r\n\r\n    data.trend.increase = increase;\r\n    data.trend.original = original;\r\n\r\n    const decimalInfo = this.getDecimalsForValue(increase);\r\n    const formatFunc = kbn.valueFormats[this.panel.format];\r\n    data.trend.increaseFormatted = formatFunc(increase, decimalInfo.decimals, decimalInfo.scaledDecimals);\r\n    data.trend.increaseRounded = kbn.roundValue(increase, decimalInfo.decimals);\r\n  }\r\n\r\n  //\r\n  // Util\r\n  //\r\n  setUnitFormat(subItem) {\r\n    this.panel.format = subItem.value;\r\n    this.refresh();\r\n  }\r\n\r\n  getDecimalsForValue(value) {\r\n    if (_.isNumber(this.panel.decimals)) {\r\n      return { decimals: this.panel.decimals, scaledDecimals: null };\r\n    }\r\n\r\n    const delta = value / 2;\r\n    let dec = -Math.floor(Math.log(Math.abs(delta)) / Math.LN10);\r\n\r\n    const magn = Math.pow(10, -dec);\r\n    const norm = delta / magn; // norm is between 1.0 and 10.0\r\n    let size = null;\r\n\r\n    if (norm < 1.5) {\r\n      size = 1;\r\n    } else if (norm < 3) { \r\n      size = 2;\r\n      // special case for 2.5, requires an extra decimal\r\n      if (norm > 2.25) {\r\n        size = 2.5;\r\n        ++dec;\r\n      }\r\n    } else if (norm < 7.5) {\r\n      size = 5;\r\n    } else {\r\n      size = 10;\r\n    }\r\n\r\n    size *= magn;\r\n\r\n    // reduce starting decimals if not needed\r\n    if (Math.floor(value) === value) {\r\n      dec = 0;\r\n    }\r\n\r\n    const result = {};\r\n    result.decimals = Math.max(0, dec);\r\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\r\n\r\n    return result;\r\n  }\r\n\r\n  invertColorOrder(colors) {\r\n    const tmp = colors[0];\r\n    colors[0] = colors[2];\r\n    colors[2] = tmp;\r\n    this.render();\r\n  }\r\n\r\n  getColorForTrendValue() {\r\n    if (!_.isFinite(this.data.trend.percent)) {\r\n      // Trend percent is not representable, probably due to an empty/ missing previous query value\r\n      // Just return the \"no-change color\"\r\n      return this.panel.trend.colors[1];\r\n    }\r\n\r\n    var value = this.data.trend.percent * this.data.trend.sign;\r\n    \r\n    var thresholds = this.panel.trend.thresholds.split(',').map(strVale => {\r\n      return Number(strVale.trim());\r\n    });\r\n\r\n    if (value < thresholds[0]){\r\n      return this.panel.trend.colors[0];\r\n    }\r\n    else if (value >= thresholds[0] && value <= thresholds[1]){\r\n      return this.panel.trend.colors[1];\r\n    }\r\n    else{\r\n      return this.panel.trend.colors[2];\r\n    }\r\n  }\r\n\r\n  // Trend colors and current value colors use a different thresholding mechanism- \r\n  // trend colors thresholds are inclusive at both ends while value colors are not, \r\n  // hence the separate functions\r\n  getColorForValue() {\r\n    if (!_.isFinite(this.data.value)) {\r\n      return null;\r\n    }\r\n\r\n    var thresholds = this.panel.thresholds.split(',').map(strVale => {\r\n      return Number(strVale.trim());\r\n    });\r\n\r\n    for (let i = thresholds.length; i > 0; i--) {\r\n      if (this.data.value >= thresholds[i - 1]) {\r\n        return this.panel.colors[i];\r\n      }\r\n    }\r\n  \r\n    return _.first(this.panel.colors);\r\n  }\r\n\r\n  //\r\n  // Rendering\r\n  //\r\n  link(scope, elem) {\r\n    this.events.on('render', () => {\r\n      const $panelContainer = elem.find('.trend-panel-value-container');\r\n      const $valueContainer = elem.find('.trend-panel-value-container > span.trend-panel-value');\r\n      const $prefixContainer = elem.find('.trend-panel-value-container > span.trend-panel-prefix');\r\n      const $postfixContainer = elem.find('.trend-panel-value-container > span.trend-panel-postfix');\r\n      const $trendContainer = elem.find('.trend-panel-trend-container');\r\n      const $signContainer = elem.find('.trend-panel-trend-container > span.trend-panel-sign');\r\n      const $unitContainer = elem.find('.trend-panel-trend-container > span.trend-panel-unit');\r\n      const $diffContainer = elem.find('.trend-panel-trend-container > span.trend-panel-diff');\r\n      const $trendValueContainer = elem.find('.trend-panel-trend-container > span.trend-panel-trend-value');\r\n      const $trendDigitContainer = elem.find('.trend-panel-trend-container > span.trend-panel-trend-digits');\r\n\r\n      $prefixContainer.html(this.panel.prefix);\r\n      $postfixContainer.html(this.panel.postfix);\r\n      $prefixContainer.css('font-size', this.panel.prefixFontSize);\r\n      $valueContainer.css('font-size', this.panel.valueFontSize);\r\n\r\n      if (this.data.valueFormatted) {\r\n        $valueContainer.html(this.data.valueFormatted);\r\n      } else {\r\n        $valueContainer.html('N/A');\r\n      }\r\n\r\n      if (this.panel.trend.show && \r\n          this.data.trend.hasOwnProperty('percent') && \r\n          this.data.trend.hasOwnProperty('sign')) {\r\n\r\n        $signContainer.html(this.panel.trend.sign[this.data.trend.sign + 1]);\r\n        $signContainer.css('font-size', this.panel.trend.signFontSize);\r\n        $trendValueContainer.html(!_.isFinite(this.data.trend.percent)? 'N/A': this.data.trend.percentFull);\r\n        $trendValueContainer.css('font-size', this.panel.trend.valueFontSize);\r\n        $trendDigitContainer.html((this.data.trend.percentDecimals && this.data.trend.percentDecimals !== 0)? '.' + this.data.trend.percentDecimals : '');\r\n\t\t    $trendDigitContainer.css('font-size', this.panel.trend.valueFontSize);\r\n        $unitContainer.html('%');\r\n        $unitContainer.css('font-size', this.panel.trend.unitFontSize);\r\n        var backgroundColor =  this.panel.trend.colorInBackground ? this.getColorForTrendValue() : '#cccccc';\r\n        var foregroundColor = this.panel.trend.colorInBackground ? '#cccccc' : this.getColorForTrendValue();\r\n\r\n        $trendContainer.removeAttr('style');\r\n        if (this.panel.trend.colorInBackground){\r\n          $trendContainer.css('background-color', backgroundColor);\r\n        }\r\n        else{\r\n          $trendContainer.css('color', foregroundColor);\r\n        }\r\n        \r\n        if (this.panel.trend.showDiff && \r\n            this.data.trend.increaseRounded && \r\n            this.data.trend.increaseRounded !== 0) {\r\n          $diffContainer.html((this.data.trend.increaseRounded > 0) ? '+' + this.data.trend.increaseFormatted : this.data.trend.increaseFormatted);\r\n          $diffContainer.css({\r\n            'background-color': foregroundColor,\r\n            'color': backgroundColor,\r\n            'font-size': '30%',\r\n            'margin-left': '15px',\r\n            'padding': '2px 4px',\r\n            'border-radius': '5px',\r\n          });\r\n        } else {\r\n          $diffContainer.html('');\r\n          $diffContainer.removeAttr('style');\r\n        }\r\n      } else {\r\n        $signContainer.html('');\r\n        $signContainer.removeAttr('style');\r\n        if (this.panel.trend.show && this.panel.targets.length == 1){\r\n          $trendValueContainer.html(\"Provide query 'B' to see trend\");\r\n        }\r\n        else{\r\n          $trendValueContainer.html('');\r\n        }\r\n        $trendValueContainer.removeAttr('style');\r\n        $unitContainer.html('');\r\n        $unitContainer.removeAttr('style');\r\n        $diffContainer.html('&nbsp;');\r\n        $diffContainer.removeAttr('style');\r\n\r\n      }\r\n\r\n      if (this.panel.isValueColored){\r\n        var color = this.getColorForValue();\r\n        if (this.panel.colorInBackground) {\r\n          $panelContainer.css('background-color', color);\r\n          $panelContainer.css('color', '');\r\n        }\r\n        else{\r\n          $panelContainer.css('color', color);\r\n          $panelContainer.css('background-color', '');\r\n        } \r\n      }\r\n      else {\r\n        $panelContainer.css('background-color', 'transparent');\r\n        $panelContainer.css('color', '');\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nTrendCtrl.templateUrl = 'module.html';\r\n"]}